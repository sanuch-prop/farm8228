<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Кошелёк — RideNow</title>
<style>
  :root{
    --ink:#eaf2ff; --muted:#a6b5cc; --stroke:rgba(255,255,255,.18);
    --glass-1:rgba(14,21,26,.55); --glass-2:rgba(14,21,26,.35);
    --g1:#ffb668; --g2:#9de9d7;
    --gutter:16px; --nav-h:92px; --card-gap-bottom:12px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    color:var(--ink);
    font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
    background:
      linear-gradient(180deg, rgba(0,0,0,.65), rgba(0,0,0,.55) 35%, rgba(0,0,0,.45) 60%, rgba(0,0,0,.55)),
      url("image.png") center/cover no-repeat fixed;
    -webkit-text-size-adjust:100%;
    -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
    padding: var(--gutter);
    padding-bottom: calc(var(--gutter) + env(safe-area-inset-bottom));
    display:flex; flex-direction:column;
    overflow:hidden;
  }

  main.card{
    width:min(760px, calc(100vw - var(--gutter)*2));
    margin:0 auto;
    border-radius:22px; border:1px solid var(--stroke);
    background:linear-gradient(180deg,var(--glass-1),var(--glass-2));
    box-shadow:0 24px 62px rgba(0,0,0,.38), inset 0 1px 0 rgba(255,255,255,.18);
    backdrop-filter: blur(14px) saturate(140%);
    max-height: calc(100dvh - var(--nav-h) - var(--card-gap-bottom) - env(safe-area-inset-bottom));
    overflow:auto; -webkit-overflow-scrolling:touch;
  }
  @supports not (backdrop-filter: blur(2px)){
    main.card{ backdrop-filter:none; background:rgba(20,24,32,.88) }
  }

  .inner{ padding:16px 16px 22px }
  .brand{ font-weight:900; display:flex; gap:8px; align-items:center; opacity:.95 }
  .brand .dot{width:8px;height:8px;border-radius:50%;background:#58e0ff;display:inline-block}
  h1{ margin:8px 0 14px; font-size:clamp(22px, 4.4vw, 26px); letter-spacing:.2px }

  .section{ margin:12px 0; padding:12px; border-radius:16px;
    background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
    border:1px solid var(--stroke);
  }

  /* карточка баланса */
  .bonus-card{
    position:relative; overflow:hidden;
    border-radius:18px; padding:16px;
    background: linear-gradient(135deg, rgba(255,182,104,.92), rgba(157,233,215,.92));
    color:#0b0f12;
    box-shadow:0 12px 34px rgba(0,0,0,.3), inset 0 1px 0 rgba(255,255,255,.45);
  }
  .bonus-card::after{
    content:""; position:absolute; right:-40px; top:-40px; width:220px; height:220px;
    background: radial-gradient(closest-side, rgba(255,255,255,.35), transparent 70%);
    border-radius:50%; filter:blur(4px); pointer-events:none;
  }
  .bc-top{display:flex; align-items:flex-start; justify-content:space-between; gap:8px}
  .bc-title{font-weight:900; opacity:.92; letter-spacing:.2px}
  .bc-rule{font-weight:900; opacity:.75}
  .bc-balance{font-size:clamp(28px, 9vw, 34px); font-weight:1000; line-height:1.05; margin:6px 0 8px}
  .bc-sub{opacity:.9; font-weight:800; line-height:1.4}
  .bc-actions{display:flex; gap:10px; margin-top:12px; flex-wrap:wrap}
  .btn{
    height:44px; padding:0 14px; border-radius:12px; border:1px solid rgba(0,0,0,.06);
    background:rgba(255,255,255,.5); backdrop-filter:saturate(140%) blur(1px);
    box-shadow:inset 0 1px 0 rgba(255,255,255,.65);
    font-weight:900; color:#0b0f12; cursor:pointer;
    min-width:44px;
  }
  .hint{margin-top:6px; font-weight:800; opacity:.75}

  .stat-row{ display:grid; grid-template-columns:1fr 1fr; gap:10px }
  .pill{
    display:flex; align-items:center; gap:8px;
    padding:10px 12px; border-radius:12px;
    border:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
    font-weight:900;
  }
  .pill .label{ color:var(--muted); font-size:12px; flex:0 0 auto }
  .pill .value{ font-size:15px; font-weight:1000 }

  .history-item{
    position:relative;
    border-radius:14px; padding:12px; margin-top:8px;
    border:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
    box-shadow:inset 0 1px 0 rgba(255,255,255,.18);
  }
  .hist-top{display:flex; align-items:center; justify-content:space-between; gap:12px}
  .hist-text{font-weight:900}
  .hist-badge{
    width:42px; height:42px; border-radius:999px; flex-shrink:0;
    display:grid; place-items:center; font-weight:1000; color:#0b0f12;
    background:linear-gradient(135deg, var(--g1), var(--g2));
    box-shadow:0 6px 16px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.6);
  }

  /* оверлей (оставил как было) */
  .overlay{position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:1100;
    background:rgba(5,8,12,.55); backdrop-filter: blur(6px) saturate(140%);}
  .overlay.open{display:flex}
  .modal{
    width:min(560px, calc(100vw - var(--gutter)*2));
    border-radius:18px; border:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(24,28,36,.96), rgba(24,28,36,.92));
    box-shadow:0 30px 80px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.22);
    transform:scale(.98); opacity:0; transition:.18s ease;
    padding:12px;
  }
  .overlay.open .modal{transform:scale(1); opacity:1}
  .modal h3{margin:4px 6px 8px; font-weight:1000}
  .modal .desc{margin:0 6px 12px; color:var(--muted); font-weight:800}
  .modal-actions{display:flex; flex-direction:column; gap:10px; padding:0 6px 6px}
  .m-btn{
    width:100%; height:48px; border-radius:12px; border:1px solid var(--stroke);
    background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
    color:var(--ink); font-weight:900; cursor:pointer;
  }
  .m-btn.ok{border:0; color:#0b0f12; background:linear-gradient(90deg,var(--g1),var(--g2))}
  .m-btn.cancel{opacity:.85}

  /* bottom nav */
  .bottom-shell{
    position:fixed; left:0; right:0; bottom:0; z-index:1001;
    padding:0 env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);
  }
  .bottom-bar{
    display:flex; justify-content:space-around; background: var(--glass-2);
    border-radius: 20px 20px 0 0; padding: 8px; backdrop-filter: blur(12px);
  }
  .bn-tab{flex:1; text-align:center; color:var(--ink); font-size:12px; text-decoration:none; padding:6px 0}
  .bn-tab .ico{font-size:18px; display:block}
  .bn-tab.active{ color: var(--g1) }
</style>
</head>
<body>
  <main class="card" id="appCard">
    <div class="inner">
      <div class="brand"><span class="dot"></span><span>RideNow</span></div>
      <h1>Кошелёк</h1>

      <!-- Баланс -->
      <section class="bonus-card" aria-label="Бонусный баланс">
        <div class="bc-top">
          <div class="bc-title">Бонусный баланс</div>
          <div class="bc-rule">100 км → 10 ₴</div>
        </div>

        <div class="bc-balance"><span id="balance">230</span> ₴</div>
        <div class="bc-sub">За каждые 100 км поездки начисляем +10 ₴ — их можно использовать у водителя как скидку.</div>

        <div class="bc-actions">
          <button class="btn" id="useBalanceBtn" aria-label="Использовать 230 гривен на оплату поездки">
            Использовать баланс кошелька на поездку
          </button>
        </div>
        <div class="hint" id="zeroHint" style="display:none">Баланс появится после поездок.</div>
      </section>

      <!-- Блок правил (будет скрываться, если есть кредит сервсбора) -->
      <section class="section" id="ruleSection" aria-label="Правила списания сбора">
        <div style="font-weight:1000; margin-bottom:6px">Если поездка не состоялась</div>
        <div style="line-height:1.4; color:var(--ink); opacity:.95">
          Мы сохраняем оплаченный сервисный сбор <b>25 ₴</b> и автоматически применим его к следующей брони.
        </div>
      </section>

      <!-- Блок статуса сервсбора (показывается вместо правил) -->
      <section class="section" id="creditSection" style="display:none" aria-label="Оплачен сервисный сбор">
        <div style="font-weight:1000; margin-bottom:6px">Оплачен сервисный сбор</div>
        <div id="creditLine" style="line-height:1.45">
          Оплачен сервисный сбор <b>25 ₴</b> — доступен для следующей брони.
        </div>
      </section>

      <!-- Статистика -->
      <section class="section" aria-label="Статистика за год">
        <div class="stat-row">
          <div class="pill"><span class="label">За год</span><span class="value" id="sTrips">1</span><span class="label">поездка</span></div>
          <div class="pill"><span class="label">За год</span><span class="value" id="sKm">470</span><span class="label">км</span></div>
        </div>
      </section>

      <!-- История -->
      <section class="section" aria-label="История начислений">
        <div style="font-weight:1000; margin-bottom:6px">История начислений</div>
        <div class="history-item" id="histItem">
          <div class="hist-top">
            <div class="hist-text" id="histText">Киев → Одесса · 470 км</div>
            <div class="hist-badge" id="histBonus">+47</div>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Навигация -->
  <nav class="bottom-shell" id="nav" aria-label="Навигация">
    <div class="bottom-bar">
      <a class="bn-tab" href="passenger-profile.html"><div class="ico">👤</div>Профиль</a>
      <a class="bn-tab active" href="passenger-wallet.html"><div class="ico">💳</div>Кошелёк</a>
      <a class="bn-tab" href="passenger-active.html"><div class="ico">🚗</div>Актуальная</a>
      <a class="bn-tab" href="passenger-search.html"><div class="ico">🔍</div>Поиск</a>
    </div>
  </nav>

  <!-- Оверлей: выбор куда применить баланс -->
  <div class="overlay" id="overlay" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Куда применить оплату?</h3>
      <div class="desc">Списываем бонусы с кошелька. Выберите:</div>
      <div class="modal-actions">
        <button class="m-btn ok" id="goActual">Поездка находится в «Актуальных»</button>
        <button class="m-btn ok" id="goSearch">Выбрать новую поездку</button>
        <button class="m-btn cancel" id="ovCancel">Отмена</button>
      </div>
    </div>
  </div>

<script>
  // ===== демо-данные для истории/баланса
  const state = { balance: 230 };
  const stats = { trips: 1, km: 470 };
  const last = { route:'Киев → Одесса', km:470, bonus:47 };

  // ===== ключ с кредитом сервсбора (создаёт его экран «Оплачено»)
  const CREDIT_KEY = 'rn:svcfee:credit';

  function readCredit(){
    try { return JSON.parse(localStorage.getItem(CREDIT_KEY)); } catch { return null; }
  }
  function writeCredit(c){ localStorage.setItem(CREDIT_KEY, JSON.stringify(c)); }

  // если кредит был залочен и TTL вышел — разблокируем для следующей брони
  function normalizeCredit(c){
    if (!c) return null;
    if (c.state === 'locked' && typeof c.expiresAt === 'number' && Date.now() > c.expiresAt){
      c.state = 'ready';
      delete c.lockedForTripId;
      delete c.lockedAt;
      delete c.expiresAt;
      writeCredit(c);
    }
    return c;
  }

  function mmss(ms){
    const s = Math.max(0, Math.floor(ms/1000));
    const m = Math.floor(s/60);
    const ss = String(s%60).padStart(2,'0');
    return `${m}:${ss}`;
  }

  let countdownTimer = null;
  function renderCreditUI(){
    const ruleSec   = document.getElementById('ruleSection');
    const creditSec = document.getElementById('creditSection');
    const line      = document.getElementById('creditLine');

    let c = normalizeCredit(readCredit());

    // нет кредита или он израсходован — показываем правила
    if (!c || c.amount < 25 || c.state === 'consumed' || c.state === 'cancelled'){
      creditSec.style.display = 'none';
      ruleSec.style.display = '';
      if (countdownTimer){ clearInterval(countdownTimer); countdownTimer=null; }
      return;
    }

    // есть кредит — показываем плашку и скрываем правила
    ruleSec.style.display = 'none';
    creditSec.style.display = '';

    if (c.state === 'locked'){
      // показываем, что зарезервирован и сколько осталось времени
      const until = c.expiresAt || (Date.now()+60*60*1000);
      function tick(){
        const left = until - Date.now();
        if (left <= 0){
          clearInterval(countdownTimer); countdownTimer=null;
          // авторазблокируем и перерисуем
          c = normalizeCredit(readCredit());
          renderCreditUI();
          return;
        }
        line.innerHTML = `Оплачен сервисный сбор <b>25 ₴</b> — <span style="opacity:.9">зарезервирован за поездкой</span>. Осталось: <b>${mmss(left)}</b>`;
      }
      tick();
      if (!countdownTimer){ countdownTimer = setInterval(tick, 1000); }
    } else {
      // готов к использованию
      line.innerHTML = `Оплачен сервисный сбор <b>25 ₴</b> — доступен для следующей брони.`;
      if (countdownTimer){ clearInterval(countdownTimer); countdownTimer=null; }
    }
  }

  // ===== базовый рендер твоих блоков
  function render(){
    document.getElementById('balance').textContent = state.balance;
    document.getElementById('useBalanceBtn').setAttribute('aria-label', `Использовать ${state.balance} гривен на оплату поездки`);
    document.getElementById('zeroHint').style.display = state.balance<=0 ? 'block' : 'none';

    document.getElementById('sTrips').textContent = stats.trips;
    document.getElementById('sKm').textContent = stats.km;

    document.getElementById('histText').textContent = `${last.route} · ${last.km} км`;
    document.getElementById('histBonus').textContent = `+${last.bonus}`;

    renderCreditUI();
  }

  // высота навбара
  (function setNavHeight(){
    const nav = document.getElementById('nav');
    const set = ()=> document.documentElement.style.setProperty('--nav-h', (nav?.offsetHeight||92) + 'px');
    set(); window.addEventListener('resize', set);
  })();

  // оверлей (как было)
  const overlay = document.getElementById('overlay');
  document.getElementById('useBalanceBtn').addEventListener('click', ()=>{ overlay.classList.add('open'); overlay.setAttribute('aria-hidden','false'); });
  document.getElementById('ovCancel').addEventListener('click', ()=>{ overlay.classList.remove('open'); overlay.setAttribute('aria-hidden','true'); });
  overlay.addEventListener('click', e=>{ if(e.target===overlay){ overlay.classList.remove('open'); overlay.setAttribute('aria-hidden','true'); }});
  document.getElementById('goActual').addEventListener('click', ()=> location.href='passenger-trip.html');
  document.getElementById('goSearch').addEventListener('click', ()=> location.href='passenger-search.html');

  // обновляем UI если кредит изменился из другой страницы/вкладки
  window.addEventListener('storage', (e)=>{ if(e.key === CREDIT_KEY){ renderCreditUI(); }});

  render();
</script>
</body>
</html>
