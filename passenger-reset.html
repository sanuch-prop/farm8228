<!DOCTYPE html>
<html lang="ru">
<head>
<script>window.RN_I18N_OPTS={mountGlobal:false};</script>
<script src="/js/i18n.js"></script>
<script src="/js/auth.js"></script>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Смена пароля — RideNow</title>
<style>
html,body{height:100%;margin:0}
body{
  overflow:hidden;
  overscroll-behavior:contain;
  background:
    linear-gradient(180deg, rgba(0,0,0,.65), rgba(0,0,0,.55) 35%, rgba(0,0,0,.45) 60%, rgba(0,0,0,.55)),
    url("image.png") center/cover no-repeat fixed;
}
.app{
  min-height:100svh;
  display:flex; align-items:center; justify-content:center;
  padding-inline:clamp(14px,4vw,24px);
  padding-top:calc(12px + env(safe-area-inset-top,0px));
  padding-bottom:calc(12px + env(safe-area-inset-bottom,0px));
}
.card{
  max-height:calc(100svh - 24px - env(safe-area-inset-top,0px) - env(safe-area-inset-bottom,0px));
  overflow:auto;
  -webkit-overflow-scrolling:touch;
}
.card:focus{ outline:none }
.card a, .card button { text-decoration: none; }
.card a:focus-visible, .card button:focus-visible{ outline:2px solid rgba(255,255,255,.45); outline-offset:2px; }
/* Линки-кнопки без подчеркивания, но с видимым focus */
a.btn, a.cta, .actions a { text-decoration:none !important; }
a.btn:focus-visible, a.cta:focus-visible, .actions a:focus-visible,
button.btn:focus-visible, .btn-sec:focus-visible {
  outline:0;
  box-shadow:0 0 0 3px rgba(255,255,255,.35);
  text-decoration:none !important;
}
:root{
  --glass-1: rgba(14,21,26,.55);
  --glass-2: rgba(14,21,26,.35);
  --ink:#f3f7ff; --muted:#c4ceda; --stroke:rgba(255,255,255,.18);
  --accent:#ffb668; --accent-2:#9de9d7;
  --gutter-inline: clamp(14px, 4vw, 24px);
  --gutter-block: 12px;
  --font:15px; --maxw:640px;
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
}
*{box-sizing:border-box} html,body{height:100%;margin:0}
body{
  color:var(--ink);
  font:500 var(--font)/1.25 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
  background:
    linear-gradient(180deg, rgba(0,0,0,.65), rgba(0,0,0,.55) 35%, rgba(0,0,0,.45) 60%, rgba(0,0,0,.55)),
    url("image.png") center/cover no-repeat fixed;
  -webkit-text-size-adjust:100%; -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
  overflow:auto;
}
.app{ min-height:100svh; display:flex; align-items:center; justify-content:center;
  padding-inline:var(--gutter-inline);
  padding-top:calc(var(--gutter-block) + var(--safe-top));
  padding-bottom:calc(var(--gutter-block) + var(--safe-bottom));
}
body.kbd-open .app{ align-items:flex-start; }
.card{
  width:100%; max-width:var(--maxw);
  border-radius:22px; border:1px solid var(--stroke);
  background:linear-gradient(180deg,var(--glass-1),var(--glass-2));
  box-shadow:0 24px 60px rgba(0,0,0,.55), inset 0 1px 0 rgba(255,255,255,.25);
  backdrop-filter: blur(16px) saturate(140%);
  padding:12px;
}
.topbar{display:flex; align-items:center; justify-content:space-between; min-height:36px; padding:2px 4px}
.brand{display:flex;align-items:center;gap:8px;font-weight:900;opacity:.95}
.brand .dot{width:8px;height:8px;border-radius:999px;background:#58e0ff;display:inline-block}

.langs{display:flex;gap:6px}
.lang-btn{
  min-width:44px; height:30px; padding:0 10px;
  border-radius:12px; border:1px solid var(--stroke);
  background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.04));
  color:var(--ink); font-weight:800; cursor:pointer;
  box-shadow:inset 0 1px 0 rgba(255,255,255,.25);
}
.lang-btn.is-active,
.lang-btn[aria-pressed="true"]{
  border:none; color:#0b0f12;
  background:linear-gradient(180deg,var(--accent),var(--accent-2));
  box-shadow:0 10px 20px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.6);
}

.content{display:flex;flex-direction:column;gap:10px}
h1{margin:4px 0 6px;font-size:24px;text-align:center}
.banner{
  display:none; border:1px solid var(--stroke);border-radius:12px;padding:10px 12px;
  background:linear-gradient(180deg,rgba(255,0,0,.10),rgba(255,255,255,.03));
  color:#ffd59b;text-align:center;
}
.banner a{color:#ffd59b}

.field{margin:6px 0; position:relative}
.input{
  width:100%;padding:10px 42px 10px 12px;border-radius:12px;border:1px solid var(--stroke);
  background:rgba(255,255,255,.08);color:var(--ink);font-weight:700;font-size:16px;outline:none;
}
.input:focus{box-shadow:0 0 0 2px rgba(255,255,255,.18) inset}
.eye{
  position:absolute; right:8px; top:50%; transform:translateY(-50%);
  border:1px solid var(--stroke); background:linear-gradient(180deg,rgba(255,255,255,.10),rgba(255,255,255,.04));
  color:var(--ink); font-weight:800; border-radius:10px; padding:6px 8px; cursor:pointer;
}
.help{color:var(--muted);font-size:.95em}
.str{height:6px;border-radius:999px;background:rgba(255,255,255,.15);overflow:hidden}
.str>span{display:block;height:100%;width:0%;background:linear-gradient(90deg,#ff8a65,#ffd59b,#9de9d7)}

.cta-stick{position:sticky;bottom:calc(var(--safe-bottom) + 12px);z-index:10;padding-top:4px;background:linear-gradient(to top, rgba(11,15,18,.35), rgba(11,15,18,0));border-radius:12px;backdrop-filter:saturate(120%)}
.cta{width:100%;padding:12px 16px;border:none;cursor:pointer;border-radius:14px;font-weight:900;background:linear-gradient(180deg,var(--accent),var(--accent-2));color:#0b0f12;box-shadow:0 10px 22px rgba(0,0,0,.35), inset 0 1px 0 rgba(255,255,255,.6)}
.alt{margin-top:6px;color:var(--muted);text-align:center}
.alt a{color:#ffd59b;text-decoration:none}
.err{color:#ffccaa;font-size:.95em}
@media (max-height:640px){
  :root{--font:14px}
  h1{font-size:22px}
  .input{padding:9px 40px 9px 11px}
  .cta{padding:11px 14px}
}
</style>
</head>
<body>
  <main class="app">
    <section class="card" role="dialog" aria-labelledby="title">
      <div class="topbar" aria-label="Хедер карточки">
        <div class="brand"><span class="dot"></span><span>RideNow</span></div>
        <div class="langs" role="tablist" aria-label="Выбор языка">
          <button class="lang-btn" data-lang="ru" aria-pressed="false">RU</button>
          <button class="lang-btn" data-lang="uk" aria-pressed="false">UA</button>
          <button class="lang-btn" data-lang="en" aria-pressed="false">EN</button>
        </div>
      </div>
      <form class="content" id="resetForm" novalidate>
  <h1 id="title" data-i18n="reset_title">Смена пароля</h1>

        <div id="banner" class="banner" role="alert" aria-live="polite" style="display:none">
          <span data-i18n="link_invalid">Ссылка недействительна или истекла.</span>
          <a href="passenger-restore.html" data-i18n="ask_new_link">Запросить новую ссылку</a>.
        </div>

        <label class="field" for="p1">
          <input id="p1" class="input" type="password" data-i18n-ph="new_pass" placeholder="Новый пароль" autocomplete="new-password" required>
          <button class="eye" type="button" data-t="p1" data-i18n="show">Показать</button>
        </label>
        <div class="str"><span id="meter"></span></div>
        <div class="help" data-i18n="pass_rules">Минимум 8 символов</div>

        <label class="field" for="p2">
          <input id="p2" class="input" type="password" data-i18n-ph="confirm_pass" placeholder="Повторите пароль" autocomplete="new-password" required>
          <button class="eye" type="button" data-t="p2" data-i18n="show">Показать</button>
        </label>
        <div class="err" id="err" role="alert" aria-live="polite"></div>

        <div class="cta-stick">
          <button class="cta" type="submit" id="saveBtn" data-i18n="change_pass">Сменить пароль</button>
        </div>

        <div class="alt"><a href="index.html" data-i18n="back_to_login">Назад ко входу</a></div>
      </form>
    </section>
  </main>

<script>
const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
const meter=$('#meter'), p1=$('#p1'), p2=$('#p2'), err=$('#err'), banner=$('#banner'), saveBtn=$('#saveBtn');
// Strength meter hookup after elements exist
function strength(v){ let s=0; if(v.length>=8) s++; if(/[A-Za-z]/.test(v)) s++; if(/\d/.test(v)) s++; if(/[^A-Za-z0-9]/.test(v)) s++; return Math.min(100, s*25); }
p1.addEventListener('input',()=>{ meter.style.width=strength(p1.value)+'%'; });

// Language switch handled by i18n.js

// Overlay pattern (reuse from index.html)
let overlay=null;
function showOverlay(title, text) {
  if (!overlay) {
    overlay = document.createElement('section');
    overlay.className = 'redir is-open';
    overlay.innerHTML = `<div class="redir-card" role="alertdialog"><h2 id="rTitle"></h2><p id="rText"></p></div>`;
    document.body.appendChild(overlay);
  }
  overlay.querySelector('#rTitle').textContent = title;
  overlay.querySelector('#rText').textContent = text;
  overlay.setAttribute('aria-hidden','false');
  overlay.style.display = 'grid';
}
function hideOverlay() {
  if (overlay) { overlay.style.display = 'none'; overlay.setAttribute('aria-hidden','true'); }
}

// Show/hide password
$$('.eye').forEach(btn=>{
  btn.addEventListener('click',()=>{
    const id=btn.dataset.t, input=$('#'+id);
    const to=input.type==='password'?'text':'password';
    input.type=to;
    btn.textContent = to==='text' ? (window.RN_I18N?.dict?.[window.RN_I18N.get()]?.hide || 'Скрыть') : (window.RN_I18N?.dict?.[window.RN_I18N.get()]?.show || 'Показать');
    input.focus();
  });
});

// Strength meter
function strength(v){ let s=0; if(v.length>=8) s++; if(/[A-Za-z]/.test(v)) s++; if(/\d/.test(v)) s++; if(/[^A-Za-z0-9]/.test(v)) s++; return Math.min(100, s*25); }
p1.addEventListener('input',()=>{ meter.style.width=strength(p1.value)+'%'; });

// Session check and redirect
if (window.rnRedirectIfAuthed) rnRedirectIfAuthed('/passenger-search.html');
if (window.rnHandleSupabaseRedirect) rnHandleSupabaseRedirect();

// Form submit
$('#resetForm').addEventListener('submit',async e=>{
  e.preventDefault();
  err.textContent='';
  if(p1.value.length<8){
    err.textContent=window.RN_I18N?.dict?.[window.RN_I18N.get()]?.pass_rules || 'Минимум 8 символов'; p1.focus(); return;
  }
  if(p1.value!==p2.value){ err.textContent=window.RN_I18N?.dict?.[window.RN_I18N.get()]?.confirm_pass || 'Пароли не совпадают.'; p2.focus(); return; }
  try {
    showOverlay(
      window.RN_I18N?.dict?.[window.RN_I18N.get()]?.reset_title || 'Смена пароля',
      window.RN_I18N?.dict?.[window.RN_I18N.get()]?.redir_text_connect || 'Меняем пароль…'
    );
    if (!window.sb?.auth?.updateUser) throw new Error('Нет сессии для смены пароля');
    await window.sb.auth.updateUser({ password: p1.value });
    hideOverlay();
    window.location = 'passenger-reset-done.html';
  } catch (e) {
    hideOverlay();
    err.textContent = e?.message || 'Ошибка смены пароля';
    err.focus();
  }
});

// Link/session check (simulate: if no session, show banner)
if (!window.sb?.auth?.session) {
  banner.style.display = 'block';
  saveBtn.disabled = true;
  banner.focus();
}

// A11y: focus error/banner

addEventListener('focusin',e=>{ if(e.target.matches('input,textarea,[contenteditable="true"]')) document.body.classList.add('kbd-open'); });
addEventListener('focusout',()=>{ setTimeout(()=>{ if(!document.querySelector('input:focus,textarea:focus,[contenteditable="true"]:focus')) document.body.classList.remove('kbd-open'); },50); });
</script>
</body>
</html>
