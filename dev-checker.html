<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>RideNow — Dev-чекер связок</title>
<style>
:root{
  --ink:#eaf2ff; --muted:#a6b5cc; --stroke:rgba(255,255,255,.18);
  --glass1:rgba(14,21,26,.55); --glass2:rgba(14,21,26,.35);
  --g1:#ffb668; --g2:#9de9d7; --ok:#7cf7c9; --warn:#ffd59b; --err:#ff9b9b;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0}
body{
  color:var(--ink); font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:
    linear-gradient(180deg, rgba(0,0,0,.65), rgba(0,0,0,.55) 35%, rgba(0,0,0,.45) 60%, rgba(0,0,0,.55)),
    url("image.png") center/cover no-repeat fixed;
  -webkit-font-smoothing:antialiased; text-rendering:optimizeLegibility;
  padding:16px; display:grid; grid-template-columns:minmax(320px,520px) 1fr; gap:14px;
}

/* панель слева */
.left{
  border:1px solid var(--stroke); border-radius:18px;
  background:linear-gradient(180deg,var(--glass1),var(--glass2));
  box-shadow:0 30px 80px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.22);
  backdrop-filter:blur(14px) saturate(140%); overflow:hidden; display:flex; flex-direction:column;
}
.header{
  display:flex; align-items:center; justify-content:space-between; gap:8px;
  padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.14)
}
.brand{display:flex; gap:8px; align-items:center; font-weight:900}
.brand .dot{width:8px;height:8px;border-radius:50%;background:linear-gradient(180deg,#58e0ff,#9de9d7)}
.hbtn{height:40px;border-radius:12px;border:1px solid var(--stroke);background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06)); color:var(--ink);font-weight:800;padding:0 12px;cursor:pointer}
.hbtn.primary{border:0;color:#0b0f12;background:linear-gradient(90deg,var(--g1),var(--g2))}

.preview{flex:1; position:relative; overflow:auto}
.preview .frame{
  width:100%; border:0; height:calc(100% - 0px); display:block; background:#0b0f12
}
.note{font-size:12px; color:var(--muted); padding:6px 10px; border-top:1px solid rgba(255,255,255,.12)}

/* правая колонка */
.right{
  border:1px solid var(--stroke); border-radius:18px;
  background:linear-gradient(180deg,var(--glass1),var(--glass2));
  box-shadow:0 30px 80px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.22);
  backdrop-filter:blur(14px) saturate(140%); overflow:auto; padding:12px;
}
.h1{display:flex; align-items:center; justify-content:space-between; gap:8px}
.stat{font-weight:900; padding:6px 12px; border-radius:12px; background:rgba(255,255,255,.10); border:1px solid var(--stroke)}
.stat.ok{background:rgba(124,247,201,.14); border-color:rgba(124,247,201,.35)}
.stat.warn{background:rgba(255,213,155,.14); border-color:rgba(255,213,155,.35)}
.stat.err{background:rgba(255,155,155,.16); border-color:rgba(255,155,155,.38)}
.section{border:1px solid var(--stroke); border-radius:16px; padding:12px; margin-top:10px;
  background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06))}
.row-badges{display:flex; gap:8px; flex-wrap:wrap}
.badge{
  display:inline-grid; place-items:center; padding:8px 12px; border-radius:12px; font-weight:900;
  border:1px solid var(--stroke); background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
  color:var(--ink); white-space:nowrap
}
.badge.ok{background:linear-gradient(90deg,var(--g1),var(--g2)); color:#062b14; border:0}
.badge.miss{background:rgba(255,213,155,.14); border-color:rgba(255,213,155,.35)}
.badge.dim{opacity:.75}
.small{color:var(--muted); font-size:13px}

.kv{display:grid; grid-template-columns: 180px 1fr; gap:8px; align-items:start}
.kv .k{color:#cfe3ff}

/* кастомный выбор страницы (вместо белого системного select) */
.sheet{position:fixed; inset:0; display:none; place-items:center; z-index:55}
.sheet.show{display:grid}
.dim{position:absolute; inset:0; background:rgba(0,0,0,.55); backdrop-filter:blur(3px)}
.picker{
  position:relative; width:min(720px,98vw); max-height:80vh; overflow:hidden; display:flex; flex-direction:column;
  border:1px solid var(--stroke); border-radius:16px; background:linear-gradient(180deg,var(--glass1),var(--glass2));
  box-shadow:0 30px 80px rgba(0,0,0,.6), inset 0 1px 0 rgba(255,255,255,.22);
}
.phead{display:flex; gap:8px; align-items:center; padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.12)}
.phead input{flex:1;height:40px;border-radius:10px;border:1px solid var(--stroke);background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));color:var(--ink);padding:0 12px}
.plist{overflow:auto; padding:10px; display:grid; gap:8px}
.pitem{display:flex; justify-content:space-between; gap:8px; align-items:center; padding:10px 12px; border:1px solid var(--stroke); border-radius:12px; cursor:pointer;
  background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06))}
.pitem:hover{outline:2px solid rgba(157,233,215,.45)}
.pitem .t{font-weight:900}
.pitem .s{color:var(--muted); font-size:12px}

/* мини-лог */
.log{font-family:ui-monospace,SFMono-Regular,Consolas,Menlo,monospace; font-size:12px; white-space:pre-wrap; background:rgba(0,0,0,.22);
  border:1px dashed rgba(255,255,255,.22); padding:10px; border-radius:12px}

/* кнопки сверху */
.actions{display:flex; gap:8px; flex-wrap:wrap}
.btn{height:40px;border-radius:12px;border:1px solid var(--stroke);
  background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
  color:var(--ink); font-weight:800; padding:0 12px; cursor:pointer}
.btn.pri{border:0; color:#0b0f12; background:linear-gradient(90deg,var(--g1),var(--g2))}
.btn.ghost{opacity:.9}
</style>
</head>
<body>

<!-- левая панель: превью + выбор страницы -->
<div class="left">
  <div class="header">
    <div class="brand"><span class="dot"></span><span>RideNow</span> <span class="small" style="margin-left:6px">Dev-чекер связок</span></div>
    <div class="actions">
      <button class="hbtn" id="pickBtn">Выбрать страницу</button>
      <button class="hbtn primary" id="runAllBtn">Проверить всё</button>
    </div>
  </div>

  <div class="preview">
    <iframe id="frame" class="frame" title="Превью страницы" src="index.html"></iframe>
  </div>
  <div class="note" id="footNote">Страница загружена: <b id="curName">index.html</b></div>
</div>

<!-- правая панель: результаты -->
<div class="right" id="right">
  <div class="h1">
    <div style="font-weight:900">Результаты по странице</div>
    <div class="actions">
      <button class="btn" id="quickBtn">Быстрый прогон</button>
      <button class="btn pri" id="exportBtn">Экспорт отчёта</button>
      <span class="stat ok" id="summaryStat">OK</span>
    </div>
  </div>

  <div class="section">
    <div style="font-weight:900; margin-bottom:6px">Кнопки / элементы (должны быть)</div>
    <div class="small">Ниже — всё кликабельное, что реально найдено на странице. Кнопки с переходами (через JS) тоже попадут в список.</div>
    <div class="row-badges" id="mustButtons"></div>
  </div>

  <div class="section">
    <div style="font-weight:900; margin-bottom:6px">Навигация / найденные ссылки</div>
    <div class="row-badges" id="navFound"></div>
  </div>

  <div class="section">
    <div style="font-weight:900; margin-bottom:6px">Достижимость по графу (куда можно попасть)</div>
    <div class="row-badges" id="graphBadges"></div>
  </div>

  <div class="section">
    <div style="font-weight:900; margin-bottom:6px">Автопроверки кликов</div>
    <div class="log" id="clickLog">—</div>
  </div>

  <div class="section">
    <div style="font-weight:900; margin-bottom:6px">Рекомендации: сервер / уведомления / интеграции</div>
    <div class="kv">
      <div class="k">Аккаунт/Профиль</div><div id="recProfile" class="small"></div>
      <div class="k">Оплата/Кошелёк</div><div id="recWallet"  class="small"></div>
      <div class="k">Поездки</div><div id="recTrips"   class="small"></div>
      <div class="k">Уведомления</div><div id="recNotify" class="small"></div>
      <div class="k">Карты/Звонок</div><div id="recMapCall" class="small"></div>
    </div>
  </div>

  <div class="section">
    <div style="font-weight:900; margin-bottom:6px">Подсказки по дублям</div>
    <div class="log" id="dupLog">—</div>
  </div>
</div>

<!-- кастомный выбор страницы -->
<div class="sheet" id="picker">
  <div class="dim" data-close></div>
  <div class="picker">
    <div class="phead">
      <div style="font-weight:900">Выберите страницу</div>
      <input id="searchInp" placeholder="Поиск по имени или заголовку…" />
      <button class="hbtn" data-close>Закрыть</button>
    </div>
    <div class="plist" id="plist"></div>
  </div>
</div>

<script>
/* ========= КОНФИГ ========= */
const PAGES = [
  {file:'index.html',                    title:'Вход — RideNow'},
  {file:'passenger-profile.html',        title:'Профиль пассажира'},
  {file:'passenger-wallet.html',         title:'Кошелёк'},
  {file:'passenger-active.html',         title:'Актуальная'},
  {file:'passenger-search.html',         title:'Поиск — RideNow'},
  {file:'passenger-trip.html',           title:'Поездка (старый вариант)'},
  {file:'passenger-trip-pending.html',   title:'Поездка в ожидании'},
  {file:'passenger-trip-live.html',      title:'Поездка — подтверждена'},
  {file:'passenger-trip-ongoing.html',   title:'Поездка в пути'},
  {file:'passenger-trip-cancelled.html', title:'Бронь отменена'},
  {file:'passenger-pay-create.html',     title:'Оплата — создание'},
  {file:'passenger-pay-card.html',       title:'Оплата картой'},
  {file:'passenger-receipt.html',        title:'Квитанция'},
  {file:'passenger-register.html',       title:'Регистрация'},
  {file:'passenger-reset.html',          title:'Сброс пароля'},
  {file:'passenger-reset-done.html',     title:'Пароль сброшен'},
  {file:'passenger-restore.html',        title:'Восстановление'},
  {file:'passenger-finish.html',         title:'Завершение'},
  {file:'passenger-legal.html',          title:'Правовая информация'},
  {file:'passenger-settings.html',       title:'Настройки'},
  {file:'квитанция.html',                title:'Квитанция (старый)'},
  {file:'driver-create-trip.html',       title:'Водитель — создать поездку'},
  {file:'dev-checker.html',              title:'Dev-чекер (текущий)'},
];

const BOTTOM_NAV = [
  {name:'Профиль', file:'passenger-profile.html'},
  {name:'Кошелёк', file:'passenger-wallet.html'},
  {name:'Актуальная', file:'passenger-active.html'},
  {name:'Поиск', file:'passenger-search.html'},
];

// ожидаемые действия (ключ: файл -> массив ожидаемых внутренних переходов/кнопок)
const EXPECT = {
  'index.html': [
    ...BOTTOM_NAV.map(x=>x.file)
  ],
  'passenger-profile.html': [
    ...BOTTOM_NAV.map(x=>x.file),
    'passenger-settings.html'
  ],
  'passenger-wallet.html': [
    ...BOTTOM_NAV.map(x=>x.file),
    // внутренние кнопки:
    {text:'Использовать баланс', kind:'button'},
    {text:'Оплачен сервисный сбор', kind:'button'},
    {text:'История начислений', kind:'button'}
  ],
  'passenger-trip-pending.html': [
    ...BOTTOM_NAV.map(x=>x.file),
    // ожидалось: поиск/отмена/карта
    {text:'Искать другую', to:'passenger-search.html'},
    {text:'Отменить бронь', to:'passenger-trip-cancelled.html'},
    {text:'Посмотреть на карте', kind:'link'}
  ],
  'passenger-trip-live.html': [
    ...BOTTOM_NAV.map(x=>x.file),
    'passenger-receipt.html',
    {text:'Позвонить', kind:'button'},
    {text:'Открыть чат', kind:'button'}
  ],
  'passenger-trip-ongoing.html': [
    ...BOTTOM_NAV.map(x=>x.file),
    {text:'Набрать', kind:'button'},
    {text:'Написать', kind:'button'}
  ],
  'passenger-trip-cancelled.html': [
    ...BOTTOM_NAV.map(x=>x.file),
    {text:'Искать новую', to:'passenger-search.html'},
    {text:'В «Кошелёк»', to:'passenger-wallet.html'}
  ],
  'passenger-pay-create.html': [
    ...BOTTOM_NAV.map(x=>x.file),
    'passenger-pay-card.html'
  ],
  'passenger-pay-card.html': [
    ...BOTTOM_NAV.map(x=>x.file),
    'passenger-pay-success.html' // может отсутствовать — просто как маркер редиректа-демо
  ],
  'passenger-receipt.html': [
    ...BOTTOM_NAV.map(x=>x.file),
    {text:'Скачать PDF', kind:'button'},
    {text:'Отправить на email', kind:'button'}
  ]
};

/* ========= УТИЛЫ ========= */
const $ = s=>document.querySelector(s);
const el = (t,cls,txt)=>{const d=document.createElement(t); if(cls)d.className=cls; if(txt)d.textContent=txt; return d;};

function badge(txt, cls=''){ const b=el('div','badge '+cls,txt); return b; }
function bOk(txt){return badge(txt,'ok')}
function bMiss(txt){return badge(txt,'miss')}
function bDim(txt){return badge(txt,'dim')}

function setStat(okCount, warnCount){
  const st = $('#summaryStat');
  if (warnCount>0){ st.textContent=`Есть предупреждений: ${warnCount}`; st.className='stat warn'; }
  else { st.textContent='OK'; st.className='stat ok'; }
}

/* ========= ПРЕВЬЮ / ПИКЕР ========= */
const frame = $('#frame'), curNameEl=$('#curName');
const picker = $('#picker'), plist = $('#plist'), searchInp = $('#searchInp');

function openPicker(){ picker.classList.add('show'); searchInp.value=''; renderPickList(); searchInp.focus(); }
function closePicker(){ picker.classList.remove('show'); }
picker.addEventListener('click', e=>{ if(e.target.dataset.close!==undefined) closePicker(); });

$('#pickBtn').onclick = openPicker;
$('#runAllBtn').onclick = ()=> runAllPages();
$('#quickBtn').onclick   = ()=> analyzeCurrent();
$('#exportBtn').onclick  = ()=> exportReport();

function renderPickList(){
  const q = searchInp.value.toLowerCase();
  plist.innerHTML='';
  PAGES.forEach(p=>{
    if(q && !(p.file.toLowerCase().includes(q) || (p.title||'').toLowerCase().includes(q))) return;
    const item=el('div','pitem');
    const l=el('div','t', p.file);
    const r=el('div','s', p.title||'');
    item.append(l,r);
    item.onclick=()=>{ loadPage(p.file); closePicker(); };
    plist.append(item);
  });
}
searchInp.addEventListener('input', renderPickList);

/* ========= ЗАГРУЗКА СТРАНИЦЫ В iframe ========= */
let currentFile = 'index.html';
function loadPage(file){
  currentFile=file;
  frame.src=file;
  curNameEl.textContent=file;
  $('#clickLog').textContent='—';
  analyzeCurrent(); // подождём onload, позже повторим
}
frame.addEventListener('load', ()=> analyzeCurrent());

/* ========= АНАЛИЗ СТРАНИЦЫ ========= */
const reportStore = {}; // для «Экспорт отчёта»

async function analyzeCurrent(){
  const file = currentFile;
  const docHtml = await fetch(file).then(r=>r.text()).catch(()=>null);
  if(!docHtml){ $('#mustButtons').innerHTML=''; $('#navFound').innerHTML=''; $('#graphBadges').innerHTML=''; setStat(0,1); return; }

  // парсим DOM
  const parser = new DOMParser();
  const doc = parser.parseFromString(docHtml, 'text/html');

  // 1) найти кликабельное
  const clickables=[];
  doc.querySelectorAll('a[href]').forEach(a=>{
    const href=(a.getAttribute('href')||'').trim();
    const text=(a.textContent||'').trim().replace(/\s+/g,' ');
    clickables.push({kind:'link', text, href});
  });
  doc.querySelectorAll('button, [role=button]').forEach(b=>{
    const text=(b.textContent||'').trim().replace(/\s+/g,' ');
    clickables.push({kind:'button', text});
  });

  // 2) вытащить цели из JS (location.href='xxx.html' или "?page=xxx.html")
  const jsTargets = [];
  doc.querySelectorAll('script').forEach(s=>{
    const t = s.textContent||'';
    const re = /([A-Za-z0-9_\-\/]*?passenger[-\w]*\.html)/g;
    let m; while((m=re.exec(t))){ jsTargets.push(m[1]); }
  });

  // 3) нижняя навигация — конкретные ссылки
  const navFound = [];
  BOTTOM_NAV.forEach(nav=>{
    const ok = clickables.some(c=>c.kind==='link' && (c.href||'').includes(nav.file));
    navFound.push({name:nav.name, file:nav.file, ok});
  });

  // 4) собрать «куда можно попасть» (граф): нижняя + все <a> + найденные в JS
  const graphSet = new Set();
  clickables.filter(c=>c.kind==='link').forEach(c=>{
    const href=c.href.split('?')[0].split('#')[0];
    if (href.endsWith('.html')) graphSet.add(href);
  });
  jsTargets.forEach(x=>{ if(x.endsWith('.html')) graphSet.add(x); });

  // 5) проверить ожидания
  const expected = EXPECT[file]||[];
  const miss=[], okItems=[];
  expected.forEach(exp=>{
    if (typeof exp==='string'){
      if (graphSet.has(exp) || navFound.some(n=>n.file===exp && n.ok)) okItems.push(exp); else miss.push(exp);
    } else {
      // матч по тексту/типу
      const has = clickables.some(c=>{
        if(exp.kind && c.kind!==exp.kind) return false;
        const t=(c.text||'').toLowerCase();
        return t.includes((exp.text||'').toLowerCase());
      });
      if (has) okItems.push(exp.text||exp.to||'…'); else miss.push(exp.text||exp.to||'…');
    }
  });

  // 6) отрисовать
  const mustBox = $('#mustButtons'); mustBox.innerHTML='';
  expected.forEach(exp=>{
    const label = typeof exp==='string' ? exp : (exp.text||exp.to||'элемент');
    const isOk = okItems.includes(label);
    mustBox.appendChild(isOk ? bOk(label) : bMiss(label));
  });
  if (expected.length===0) mustBox.appendChild(bDim('— Нет особых требований —'));

  const navBox = $('#navFound'); navBox.innerHTML='';
  navFound.forEach(n=> navBox.appendChild(n.ok ? bOk(`${n.name} → ${n.file}`) : bMiss(`${n.name} (нет)`)));

  const graphBox = $('#graphBadges'); graphBox.innerHTML='';
  if (graphSet.size===0) graphBox.appendChild(bDim('— нет переходов —'));
  else [...graphSet].sort().forEach(f=> graphBox.appendChild(badge(f)));

  setStat(okItems.length, miss.length);

  // 7) автоклики в iframe (демо-проверки типовых кнопок)
  runAutoClicks(file);

  // 8) рекомендации и дубли
  fillRecommendations();
  showDuplicates();

  // 9) сохранить результат для отчёта
  reportStore[file] = {
    file, ok: okItems, miss, nav: navFound, graph:[...graphSet].sort(),
    title: (doc.querySelector('title')?.textContent||'').trim(),
  };
}

/* ========= АВТОКЛИКИ (внутри iframe) ========= */
function runAutoClicks(file){
  const log = $('#clickLog'); log.textContent='';
  const fwin = frame.contentWindow; const fdoc = frame.contentDocument;
  if(!fwin || !fdoc){ log.textContent='—'; return; }

  // перехват confirm/alert + фиксация навигации в iframe
  let navTo=''; const origConfirm=fwin.confirm, origAlert=fwin.alert, origHref=fwin.location.href;
  try{
    fwin.confirm = (msg)=>{ log.textContent += `confirm: ${msg}\n`; return true; };
    fwin.alert   = (msg)=>{ log.textContent += `alert: ${msg}\n`; };
  }catch{}

  const beforeUrl = fwin.location.href;
  // типовые сценарии
  const tryClickByText = (txt)=> {
    const els=[...fdoc.querySelectorAll('a,button,[role=button]')];
    const elx=els.find(e=>(e.textContent||'').trim().toLowerCase().includes(txt.toLowerCase()));
    if(elx){ elx.dispatchEvent(new fwin.MouseEvent('click',{bubbles:true})); log.textContent+=`click: "${txt}" ✓\n`; return true;}
    log.textContent+=`click: "${txt}" ×\n`; return false;
  };

  if(file==='passenger-trip-pending.html'){
    tryClickByText('отменить бронь');  // должно отработать confirm и сменить статус на странице
  }
  if(file==='passenger-trip-cancelled.html'){
    tryClickByText('искать новую');    // переход в поиск
  }
  if(file==='passenger-wallet.html'){
    tryClickByText('использовать баланс');
    tryClickByText('оплачен сервисный сбор');
    tryClickByText('история начислений');
  }

  // небольшая задержка и фиксация URL
  setTimeout(()=>{
    try{
      const afterUrl = fwin.location.href;
      if(afterUrl!==beforeUrl){
        log.textContent += `navigate: ${new URL(afterUrl).pathname}\n`;
      }
    }catch{}
    try{ fwin.confirm = origConfirm; fwin.alert = origAlert; }catch{}
  }, 300);
}

/* ========= РЕКОМЕНДАЦИИ ========= */
function fillRecommendations(){
  $('#recProfile').innerHTML =
    `• KYC через Дія: <code>POST /api/kyc/diia/start</code> → редирект на Дію → <code>POST /api/kyc/diia/callback</code> (server-to-server).<br/>
     • Верификация фото: <code>POST /api/profile/photo</code> (S3/Cloud), биометрический матч <code>/api/kyc/face-match</code>.<br/>
     • Профиль: <code>GET/PUT /api/profile</code>, аватар <code>GET /cdn/profile/{id}.jpg</code>.`;

  $('#recWallet').innerHTML =
    `• Баланс/ваучеры: <code>GET /api/wallet</code> → {bonus,vouchers}.<br/>
     • Ваучер от сервисного сбора: <code>POST /api/wallet/vouchers</code> (sourceTripId, amount=25).<br/>
     • Оплата сбора: интеграция PSP (LiqPay/Stripe/Monobank) → <code>POST /api/payments/intent</code> → веб-хуки <code>/api/payments/hooks</code>.`;

  $('#recTrips').innerHTML =
    `• Создание/поиск: <code>POST /api/trips/search</code>, <code>POST /api/bookings</code>, статус <code>PATCH /api/bookings/{id}</code> (pending/confirmed/enroute/cancelled/finished).<br/>
     • Квитанция: <code>GET /api/receipts/{bookingId}</code> (PDF/HTML).`;

  $('#recNotify').innerHTML =
    `• Push Web: сервис-воркер + Web Push (<code>/api/notify/webpush/subscribe</code>).<br/>
     • In-app realtime: WebSocket <code>wss://…/ws/notify</code> (создание/подтверждение/чат).<br/>
     • SMS/Call fallback: провайдер (Twilio/Infobip) через <code>/api/notify/sms</code>.`;

  $('#recMapCall').innerHTML =
    `• Карта: ссылки Google Maps <code>https://www.google.com/maps/dir/?api=1&origin=…&destination=…</code>.<br/>
     • Звонок: <code>tel:+380…</code> или VoIP SDK.<br/>
     • Геолокация шэринг: <code>navigator.geolocation</code> + короткая ссылка <code>/api/geo/share</code>.`;
}

/* ========= ПОИСК ДУБЛИКАТОВ ========= */
function showDuplicates(){
  const byTitle = {};
  PAGES.forEach(p=>{ const t=(p.title||'').trim().toLowerCase(); if(!t) return; (byTitle[t] ||= []).push(p.file); });
  const dups = Object.entries(byTitle).filter(([,arr])=>arr.length>1);
  const box = $('#dupLog');
  if(dups.length===0){ box.textContent='Дубликатов заголовков не обнаружено'; return; }
  box.textContent = dups.map(([t,arr])=>`• «${t}»: ${arr.join(', ')}`).join('\n')
    + '\n\nСовет: оставь одну «эталонную» страницу, вторую пометь как legacy или удали из сборки.';
}

/* ========= ПРОГОН ВСЕХ СТРАНИЦ ========= */
async function runAllPages(){
  $('#right').scrollTo({top:0,behavior:'smooth'});
  for(const p of PAGES){
    await new Promise(r=>setTimeout(r,120));
    loadPage(p.file);
  }
}

/* ========= ЭКСПОРТ ОТЧЁТА ========= */
function exportReport(){
  // Собираем HTML отчёта
  const rows = Object.values(reportStore).sort((a,b)=>a.file.localeCompare(b.file))
  .map(r=>{
    const miss = r.miss.length ? `<span style="color:#ffcb83">${r.miss.join(', ')}</span>` : '<span style="color:#7cf7c9">—</span>';
    const navOk = r.nav.filter(n=>n.ok).map(n=>n.file).join(', ') || '—';
    const graph = r.graph.join(', ') || '—';
    return `<tr>
      <td style="padding:6px 8px;border-bottom:1px solid #334">${r.file}</td>
      <td style="padding:6px 8px;border-bottom:1px solid #334">${r.title||''}</td>
      <td style="padding:6px 8px;border-bottom:1px solid #334">${miss}</td>
      <td style="padding:6px 8px;border-bottom:1px solid #334">${navOk}</td>
      <td style="padding:6px 8px;border-bottom:1px solid #334">${graph}</td>
    </tr>`;
  }).join('');

  const html = `<!doctype html><meta charset="utf-8"><title>RideNow — Отчёт Dev-чекера</title>
  <style>
    body{margin:0;padding:20px;background:#0b0f12;color:#eaf2ff;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}
    h1{margin:0 0 14px}
    table{border-collapse:collapse;width:100%;background:linear-gradient(180deg,#182027,#12161c)}
    th{ text-align:left; padding:8px; background:#1a2128; border-bottom:2px solid #334 }
    td{ font-size:14px }
    .small{color:#9fb0c9}
  </style>
  <h1>RideNow — Сводный отчёт</h1>
  <div class="small">Сгенерировано: ${(new Date()).toLocaleString()}</div>
  <table>
    <tr><th>Файл</th><th>Заголовок</th><th>Пропуски (ожидалось)</th><th>Нижняя навигация OK</th><th>Найденные переходы</th></tr>
    ${rows||''}
  </table>`;

  const blob = new Blob([html], {type:'text/html'});
  const url = URL.createObjectURL(blob);
  window.open(url, '_blank');
}

/* ========= СТАРТ ========= */
(function initPickerList(){
  renderPickList();
  // также клик по названию текущего файла
  $('#footNote').style.cursor='pointer';
  $('#footNote').onclick=openPicker;
})();
</script>
</body>
</html>
